<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一键生成剑网三表情包</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gif.js/dist/gif.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#FF7D00',
                        neutral: {
                            100: '#F5F7FA',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                            700: '#1D2129',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
           .content-auto {
                content-visibility: auto;
            }
           .backdrop-blur-sm {
                backdrop-filter: blur(4px);
            }
           .transition-transform-opacity {
                transition-property: transform, opacity;
            }
           .scale-hover {
                @apply hover:scale-105 transition-all duration-300;
            }
           .card-shadow {
                box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            }
           .canvas-container {
                position: relative;
                overflow: hidden;
                background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                    linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                    linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
                background-size: 20px 20px;
                background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            }
        }
    </style>
</head>

<body class="font-inter bg-neutral-100 min-h-screen flex flex-col">
    <!-- 主要内容区域 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- 操作区域 -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                <!-- 左侧：图片上传区 -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- 图片A上传 -->
                    <div class="bg-white rounded-xl p-6 card-shadow scale-hover">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa-solid fa-upload text-primary mr-2"></i>
                            上传背景图片
                        </h3>
                        <div class="border-2 border-dashed border-neutral-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer" id="drop-area-a">
                            <input type="file" id="image-a" accept="image/jpeg,image/png,image/gif" class="hidden">
                            <i class="fa-solid fa-image text-4xl text-neutral-400 mb-4"></i>
                            <p class="text-neutral-500 mb-2">拖放图片到这里，或</p>
                            <button class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg transition-colors" onclick="document.getElementById('image-a').click()">
                                选择图片
                            </button>
                            <p class="text-neutral-400 text-sm mt-2">支持 JPG、PNG、GIF 格式</p>
                        </div>
                        <div id="preview-a-container" class="mt-4 hidden">
                            <h4 class="text-sm font-medium text-neutral-600 mb-2">预览</h4>
                            <div class="relative rounded-lg overflow-hidden">
                                <img id="preview-a" src="" alt="背景图片预览" class="w-full h-auto object-contain max-h-40">
                                <button id="remove-a" class="absolute top-2 right-2 bg-white/80 hover:bg-white text-neutral-700 rounded-full w-6 h-6 flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-times text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 控制选项 -->
                    <div class="bg-white rounded-xl p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa-solid fa-sliders text-primary mr-2"></i>
                            调整选项
                        </h3>

                        <div class="space-y-4">
                            <div>
                                <label for="scale" class="block text-sm font-medium text-neutral-600 mb-1">叠加图片大小</label>
                                <input type="range" id="scale" min="0.1" max="5" step="0.05" value="1" class="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-primary">
                                <div class="flex justify-between text-xs text-neutral-500 mt-1">
                                    <span>更小</span>
                                    <span id="scale-value">100%</span>
                                    <span>更大</span>
                                </div>
                            </div>

                            <div>
                                <label for="rotation" class="block text-sm font-medium text-neutral-600 mb-1">叠加图片旋转角度</label>
                                <input type="range" id="rotation" min="0" max="360" step="1" value="0" class="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-primary">
                                <div class="flex justify-between text-xs text-neutral-500 mt-1">
                                    <span>0°</span>
                                    <span id="rotation-value">0°</span>
                                    <span>360°</span>
                                </div>
                            </div>

                            <div>
                                <label for="rotate-icon" class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="rotate-icon" class="mr-2">
                                    <span class="text-sm font-medium text-neutral-600">门派图标旋转(生成比较慢耐心等一下)</span>
                                </label>
                            </div>

                            <button id="reset-position" class="w-full py-2 px-4 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 rounded-lg transition-colors flex items-center justify-center">
                                <i class="fa-solid fa-refresh mr-2"></i>
                                重置位置
                            </button>

                            <button id="select-career" class="w-full py-3 px-4 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors flex items-center justify-center shadow-lg shadow-primary/20">
                                <i class="fa-solid fa-list mr-2"></i>
                                选择职业
                            </button>

                            <button id="generate" class="w-full py-3 px-4 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors flex items-center justify-center shadow-lg shadow-primary/20">
                                <i class="fa-solid fa-magic mr-2"></i>
                                生成当前职业图片(默认冰心)
                            </button>
                            
                            <button id="batch-generate" class="w-full py-3 px-4 bg-secondary hover:bg-secondary/90 text-white rounded-lg transition-colors flex items-center justify-center shadow-lg shadow-secondary/20">
                                <i class="fa-solid fa-clone mr-2"></i>
                                生成全职业图片
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 右侧：画布和结果 -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 画布区域 -->
                    <div class="bg-white rounded-xl p-6 card-shadow">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa-solid fa-paint-brush text-primary mr-2"></i>
                            图片合成区域
                        </h3>

                        <div class="canvas-container rounded-lg overflow-hidden border border-neutral-200" id="canvas-container">
                            <canvas id="canvas" class="w-full h-auto"></canvas>

                            <!-- 放置位置指示 -->
                            <div id="placement-indicator" class="absolute hidden border-2 border-dashed border-secondary cursor-move" style="width: 100px; height: 100px;"></div>

                            <!-- 加载指示器 -->
                            <div id="loading-indicator" class="absolute inset-0 bg-black/50 flex items-center justify-center hidden">
                                <div class="bg-white p-4 rounded-lg flex items-center">
                                    <i class="fa-solid fa-spinner fa-spin text-primary mr-2"></i>
                                    <span class="text-neutral-700">处理中...</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-sm text-neutral-500">
                            <p>提示：上传图片后，点击画布选择叠加图片的放置位置</p>
                        </div>
                    </div>

                    <!-- 结果区域 -->
                    <div id="result-container" class="bg-white rounded-xl p-6 card-shadow hidden">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa-solid fa-check-circle text-green-500 mr-2"></i>
                            合成结果
                        </h3>

                        <div class="canvas-container rounded-lg overflow-hidden border border-neutral-200 mb-4">
                            <canvas id="result-canvas" class="w-full h-auto"></canvas>
                        </div>

                        <div class="flex flex-wrap gap-3">
                            <button id="download" class="py-2 px-4 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors flex items-center shadow-lg shadow-primary/20">
                                <i class="fa-solid fa-download mr-2"></i>
                                下载此图片
                            </button>
                            <button id="new-edit" class="py-2 px-4 bg-white hover:bg-neutral-50 text-neutral-700 rounded-lg transition-colors flex items-center border border-neutral-200">
                                <i class="fa-solid fa-plus mr-2"></i>
                                重新选择图片
                            </button>
                        </div>
                    </div>

                    <!-- 批量结果区域 -->
                    <div id="batch-results-container" class="bg-white rounded-xl p-6 card-shadow hidden">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa-solid fa-th-large text-primary mr-2"></i>
                            批量生成结果
                        </h3>

                        <div class="flex flex-wrap gap-4 mb-4">
                            <button id="select-all" class="py-2 px-4 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors flex items-center">
                                <i class="fa-solid fa-check-square mr-2"></i>
                                全选
                            </button>
                            <button id="deselect-all" class="py-2 px-4 bg-white hover:bg-neutral-50 text-neutral-700 rounded-lg transition-colors flex items-center border border-neutral-200">
                                <i class="fa-solid fa-square mr-2"></i>
                                取消全选
                            </button>
                            <button id="download-selected" class="py-2 px-4 bg-secondary hover:bg-secondary/90 text-white rounded-lg transition-colors flex items-center">
                                <i class="fa-solid fa-download mr-2"></i>
                                下载选中图片
                            </button>
                        </div>

                        <div id="batch-results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                        <!-- 进度条 -->
                        <div id="progress-bar-container" class="hidden h-4 bg-neutral-200 rounded-md overflow-hidden">
                            <div id="progress-bar" class="h-full bg-primary" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="career-selection-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-neutral-700 mb-4">选择职业图片</h3>
            <div id="career-images" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script>
        // 初始化变量
        let imageA = null;
        let imageB = new Image();
        // 设置crossOrigin属性以允许跨域访问
        imageB.crossOrigin = 'anonymous';
        imageB.src = 'https://img.jx3box.com/image/xf/10081.png';

        // 图片B的32个默认配置链接
        const imageBUrls = [
            "https://img.jx3box.com/image/xf/10081.png",
            "https://img.jx3box.com/image/xf/10080.png",
            "https://img.jx3box.com/image/xf/10021.png",
            "https://img.jx3box.com/image/xf/10028.png",
            "https://img.jx3box.com/image/xf/10175.png",
            "https://img.jx3box.com/image/xf/10176.png",
            "https://img.jx3box.com/image/xf/10447.png",
            "https://img.jx3box.com/image/xf/10448.png",
            "https://img.jx3box.com/image/xf/10627.png",
            "https://img.jx3box.com/image/xf/10626.png",
            "https://img.jx3box.com/image/xf/10026.png",
            "https://img.jx3box.com/image/xf/10062.png",
            "https://img.jx3box.com/image/xf/10003.png",
            "https://img.jx3box.com/image/xf/10002.png",
            "https://img.jx3box.com/image/xf/10242.png",
            "https://img.jx3box.com/image/xf/10243.png",
            "https://img.jx3box.com/image/xf/10390.png",
            "https://img.jx3box.com/image/xf/10389.png",
            "https://img.jx3box.com/image/xf/10014.png",
            "https://img.jx3box.com/image/xf/10015.png",
            "https://img.jx3box.com/image/xf/10225.png",
            "https://img.jx3box.com/image/xf/10224.png",
            "https://img.jx3box.com/image/xf/10144.png",
            "https://img.jx3box.com/image/xf/10268.png",
            "https://img.jx3box.com/image/xf/10464.png",
            "https://img.jx3box.com/image/xf/10533.png",
            "https://img.jx3box.com/image/xf/10585.png",
            "https://img.jx3box.com/image/xf/10615.png",
            "https://img.jx3box.com/image/xf/10698.png",
            "https://img.jx3box.com/image/xf/10756.png",
            "https://img.jx3box.com/image/xf/10786.png",
            "https://img.jx3box.com/image/xf/0.png"
        ];

        let canvas = null;
        let ctx = null;
        let resultCanvas = null;
        let resultCtx = null;
        let placementX = 0;
        let placementY = 0;
        let scale = 1;
        let rotation = 0;
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let indicator = null;
        let isLoaded = false;
        let batchResults = []; // 存储批量生成的结果
        const careerSelectionModal = document.getElementById('career-selection-modal');
        const careerImages = document.getElementById('career-images');

        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function () {
            // 获取DOM元素
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            resultCanvas = document.getElementById('result-canvas');
            // 只有在结果区域显示时才获取resultCanvas的上下文
            // resultCtx = resultCanvas.getContext('2d');

            indicator = document.getElementById('placement-indicator');

            // 初始化事件监听
            initEventListeners();
        });

        // 初始化事件监听
        function initEventListeners() {
            // 图片上传事件
            document.getElementById('image-a').addEventListener('change', handleImageAUpload);

            // 移除图片
            document.getElementById('remove-a').addEventListener('click', removeImageA);

            // 画布点击事件
            canvas.addEventListener('click', handleCanvasClick);

            // 指示器拖拽
            indicator.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // 调整选项
            document.getElementById('scale').addEventListener('input', updateScale);
            document.getElementById('rotation').addEventListener('input', updateRotation);
            document.getElementById('reset-position').addEventListener('click', resetPosition);

            // 生成按钮
            document.getElementById('generate').addEventListener('click', generateResult);
            
            // 批量生成按钮
            document.getElementById('batch-generate').addEventListener('click', batchGenerate);

            // 下载和分享
            document.getElementById('download').addEventListener('click', downloadImage);
            document.getElementById('new-edit').addEventListener('click', resetAll);
            
            // 批量结果区域事件
            document.getElementById('select-all').addEventListener('click', selectAllResults);
            document.getElementById('deselect-all').addEventListener('click', deselectAllResults);
            document.getElementById('download-selected').addEventListener('click', downloadSelectedResults);

            // 新增：勾选框事件监听
            document.getElementById('rotate-icon').addEventListener('change', handleRotateIconChange);

            // 选择职业按钮事件
            document.getElementById('select-career').addEventListener('click', showCareerSelectionModal);
        }

        // 检查文件是否为图片
        function isImageFile(file) {
            return file.type.startsWith('image/');
        }

        // 处理背景图片上传
        function handleImageAUpload(event) {
            const file = event.target.files[0];
            if (!file || !isImageFile(file)) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                imageA = new Image();
                imageA.onload = function () {
                    document.getElementById('preview-a').src = e.target.result;
                    document.getElementById('preview-a-container').classList.remove('hidden');

                    // 如果图片B已经加载，则重置位置
                    if (imageB.complete) {
                        resetPosition();
                    }

                    drawCanvas();
                };
                imageA.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 移除背景图片
        function removeImageA() {
            imageA = null;
            document.getElementById('image-a').value = '';
            document.getElementById('preview-a-container').classList.add('hidden');
            drawCanvas();
        }

        // 处理画布点击
        function handleCanvasClick(event) {
            if (!imageA || !imageB) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;

            // 设置放置位置，使图片B的中间位置位于鼠标点击位置
            placementX = x - imageB.width * scale / 2;
            placementY = y - imageB.height * scale / 2;

            // 更新指示器位置
            updateIndicatorPosition();

            // 绘制画布
            drawCanvas();
        }

        // 开始拖拽
        function startDrag(event) {
            if (!imageB) return;

            isDragging = true;
            const rect = canvas.getBoundingClientRect();
            const indicatorRect = indicator.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            dragOffsetX = (event.clientX - indicatorRect.left - rect.left) * scaleX;
            dragOffsetY = (event.clientY - indicatorRect.top - rect.top) * scaleY;

            document.body.style.cursor = 'grabbing';
        }

        // 拖拽中
        function drag(event) {
            if (!isDragging || !imageB) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (event.clientX - rect.left) * scaleX - dragOffsetX;
            const y = (event.clientY - rect.top) * scaleY - dragOffsetY;

            // 限制在画布内
            placementX = Math.max(0, Math.min(x, canvas.width - indicator.offsetWidth));
            placementY = Math.max(0, Math.min(y, canvas.height - indicator.offsetHeight));

            // 更新指示器位置
            updateIndicatorPosition();

            // 绘制画布
            drawCanvas();
        }

        // 结束拖拽
        function endDrag() {
            isDragging = false;
            document.body.style.cursor = 'default';
        }

        // 更新指示器大小
        function updateIndicatorSize() {
            if (!imageB) return;

            const width = imageB.width * scale;
            const height = imageB.height * scale;

            indicator.style.width = `${width}px`;
            indicator.style.height = `${height}px`;
        }

        // 更新指示器位置
        function updateIndicatorPosition() {
            if (!imageB) return;

            indicator.style.left = `${placementX}px`;
            indicator.style.top = `${placementY}px`;
            indicator.classList.remove('hidden');
        }

        // 更新缩放
        function updateScale() {
            if (!imageB) return;

            scale = parseFloat(this.value);
            document.getElementById('scale-value').textContent = `${Math.round(scale * 100)}%`;

            // 更新指示器大小
            updateIndicatorSize();

            // 绘制画布
            drawCanvas();
        }

        // 更新旋转角度
        function updateRotation() {
            if (!imageB) return;

            rotation = parseFloat(this.value);
            document.getElementById('rotation-value').textContent = `${rotation}°`;

            // 绘制画布
            drawCanvas();
        }

        // 重置位置
        function resetPosition() {
            if (!imageA || !imageB) return;

            // 默认放置在画布中心
            placementX = (canvas.width - (imageB.width * scale)) / 2;
            placementY = (canvas.height - (imageB.height * scale)) / 2;
            rotation = 0;
            document.getElementById('rotation').value = 0;
            document.getElementById('rotation-value').textContent = '0°';

            // 更新指示器位置
            updateIndicatorPosition();

            // 绘制画布
            drawCanvas();
        }

        // 绘制画布
        function drawCanvas() {
            if (!imageA) {
                // 清空画布
                canvas.width = 800;
                canvas.height = 600;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            // 设置画布大小为图片A的大小
            canvas.width = imageA.width;
            canvas.height = imageA.height;

            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制图片A
            ctx.drawImage(imageA, 0, 0, canvas.width, canvas.height);

            // 如果有图片B，绘制图片B
            if (imageB && imageB.complete) {
                ctx.save();
                ctx.translate(placementX + imageB.width * scale / 2, placementY + imageB.height * scale / 2);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.drawImage(
                    imageB,
                    -imageB.width * scale / 2,
                    -imageB.height * scale / 2,
                    imageB.width * scale,
                    imageB.height * scale
                );
                ctx.restore();
            }

            // 确保指示器在可视区域内
            if (isLoaded && imageB && imageB.complete) {
                updateIndicatorPosition();
            }

            isLoaded = true;
        }

        // 处理勾选框状态变化
        function handleRotateIconChange() {
            // 可以在这里添加一些提示信息，例如提示用户重新生成图片
        }

        // 生成结果
        function generateResult() {
            if (!imageA || !imageB || !imageB.complete) {
                alert('请上传背景图片后再生成合成图片');
                return;
            }

            const rotateIcon = document.getElementById('rotate-icon').checked;

            if (rotateIcon) {
                generateGifResult();
            } else {
                // 原有的生成静态图片逻辑
                // 显示加载指示器
                document.getElementById('loading-indicator').classList.remove('hidden');

                // 获取结果画布上下文
                resultCanvas = document.getElementById('result-canvas');
                resultCtx = resultCanvas.getContext('2d');

                // 设置结果画布大小
                resultCanvas.width = imageA.width;
                resultCanvas.height = imageA.height;

                // 清空结果画布
                resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);

                // 绘制图片A
                resultCtx.drawImage(imageA, 0, 0, resultCanvas.width, resultCanvas.height);

                // 绘制图片B
                resultCtx.save();
                resultCtx.translate(placementX + imageB.width * scale / 2, placementY + imageB.height * scale / 2);
                resultCtx.rotate(rotation * Math.PI / 180);
                resultCtx.drawImage(
                    imageB,
                    -imageB.width * scale / 2,
                    -imageB.height * scale / 2,
                    imageB.width * scale,
                    imageB.height * scale
                );
                resultCtx.restore();

                // 隐藏加载指示器
                document.getElementById('loading-indicator').classList.add('hidden');

                // 显示结果区域
                document.getElementById('result-container').classList.remove('hidden');
                document.getElementById('batch-results-container').classList.add('hidden');

                // 平滑滚动到结果区域
                document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // 生成 GIF 结果
        function generateGifResult() {
            // 显示加载指示器
            document.getElementById('loading-indicator').classList.remove('hidden');

            const gif = new GIF({
                workers: 2,
                quality: 10
            });

            const frames = 36; // 旋转 360 度，36 帧
            const angleStep = 360 / frames;

            for (let i = 0; i < frames; i++) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = imageA.width;
                tempCanvas.height = imageA.height;

                // 绘制图片A
                tempCtx.drawImage(imageA, 0, 0, tempCanvas.width, tempCanvas.height);

                // 绘制图片B
                tempCtx.save();
                tempCtx.translate(placementX + imageB.width * scale / 2, placementY + imageB.height * scale / 2);
                tempCtx.rotate((rotation + i * angleStep) * Math.PI / 180);
                tempCtx.drawImage(
                    imageB,
                    -imageB.width * scale / 2,
                    -imageB.height * scale / 2,
                    imageB.width * scale,
                    imageB.height * scale
                );
                tempCtx.restore();

                gif.addFrame(tempCtx, { delay: 50 }); // 每帧延迟 50 毫秒
            }

            gif.on('finished', function (blob) {
                // 隐藏加载指示器
                document.getElementById('loading-indicator').classList.add('hidden');

                // 显示结果区域
                document.getElementById('result-container').classList.remove('hidden');
                document.getElementById('batch-results-container').classList.add('hidden');

                // 将 GIF 显示在结果画布上
                resultCanvas = document.getElementById('result-canvas');
                resultCanvas.width = imageA.width;
                resultCanvas.height = imageA.height;
                const img = new Image();
                img.src = URL.createObjectURL(blob);
                img.onload = function () {
                    resultCtx = resultCanvas.getContext('2d');
                    resultCtx.drawImage(img, 0, 0, resultCanvas.width, resultCanvas.height);
                };

                // 修改下载按钮的行为，下载 GIF
                document.getElementById('download').addEventListener('click', function () {
                    const link = document.createElement('a');
                    link.download = '合成图片.gif';
                    link.href = URL.createObjectURL(blob);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });

                // 平滑滚动到结果区域
                document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
            });
            gif.setOptions({
                width: imageA.width,
                height: imageA.height
            });

            gif.render();
        }

        // 批量生成结果
        function batchGenerate() {
            if (!imageA) {
                alert('请上传背景图片后再批量生成图片');
                return;
            }

            const rotateIcon = document.getElementById('rotate-icon').checked;

            // 显示加载指示器和进度条
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('progress-bar-container').classList.remove('hidden');

            // 清空之前的批量结果
            batchResults = [];
            document.getElementById('batch-results').innerHTML = '';

            // 依次处理每个图片B的URL
            let processedCount = 0;
            const totalCount = imageBUrls.length;

            imageBUrls.forEach((url, index) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    if (rotateIcon) {
                        // 生成 GIF
                        const gif = new GIF({
                            workers: 2,
                            quality: 10
                        });

                        const frames = 36; // 旋转 360 度，36 帧
                        const angleStep = 360 / frames;

                        for (let i = 0; i < frames; i++) {
                            const tempCanvas = document.createElement('canvas');
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCanvas.width = imageA.width;
                            tempCanvas.height = imageA.height;

                            // 绘制图片A
                            tempCtx.drawImage(imageA, 0, 0, tempCanvas.width, tempCanvas.height);

                            // 绘制图片B
                            tempCtx.save();
                            tempCtx.translate(placementX + img.width * scale / 2, placementY + img.height * scale / 2);
                            tempCtx.rotate((rotation + i * angleStep) * Math.PI / 180);
                            tempCtx.drawImage(
                                img,
                                -img.width * scale / 2,
                                -img.height * scale / 2,
                                img.width * scale,
                                img.height * scale
                            );
                            tempCtx.restore();

                            gif.addFrame(tempCtx, { delay: 50 }); // 每帧延迟 50 毫秒
                        }

                        gif.on('finished', function (blob) {
                            const resultDataUrl = URL.createObjectURL(blob);
                            batchResults.push({
                                index: index,
                                url: url,
                                dataUrl: resultDataUrl,
                                selected: true,
                                isGif: true
                            });

                            processedCount++;
                            updateProgressBar(processedCount, totalCount);

                            // 所有图片处理完成后
                            if (processedCount === totalCount) {
                                // 隐藏加载指示器和进度条
                                document.getElementById('loading-indicator').classList.add('hidden');
                                document.getElementById('progress-bar-container').classList.add('hidden');

                                // 显示批量结果区域
                                document.getElementById('batch-results-container').classList.remove('hidden');
                                document.getElementById('result-container').classList.add('hidden');

                                // 渲染批量结果
                                renderBatchResults();

                                // 平滑滚动到批量结果区域
                                document.getElementById('batch-results-container').scrollIntoView({ behavior: 'smooth' });
                            }
                        });

                        gif.setOptions({
                            width: imageA.width,
                            height: imageA.height
                        });

                        gif.render();
                    } else {
                        // 生成静态图片
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCanvas.width = imageA.width;
                        tempCanvas.height = imageA.height;

                        // 清空临时画布
                        tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

                        // 绘制图片A
                        tempCtx.drawImage(imageA, 0, 0, tempCanvas.width, tempCanvas.height);

                        // 绘制当前图片B
                        tempCtx.save();
                        tempCtx.translate(placementX + img.width * scale / 2, placementY + img.height * scale / 2);
                        tempCtx.rotate(rotation * Math.PI / 180);
                        tempCtx.drawImage(
                            img,
                            -img.width * scale / 2,
                            -img.height * scale / 2,
                            img.width * scale,
                            img.height * scale
                        );
                        tempCtx.restore();

                        // 保存结果
                        const resultDataUrl = tempCanvas.toDataURL('image/png');
                        batchResults.push({
                            index: index,
                            url: url,
                            dataUrl: resultDataUrl,
                            selected: true,
                            isGif: false
                        });

                        processedCount++;
                        updateProgressBar(processedCount, totalCount);

                        // 所有图片处理完成后
                        if (processedCount === totalCount) {
                            // 隐藏加载指示器和进度条
                            document.getElementById('loading-indicator').classList.add('hidden');
                            document.getElementById('progress-bar-container').classList.add('hidden');

                            // 显示批量结果区域
                            document.getElementById('batch-results-container').classList.remove('hidden');
                            document.getElementById('result-container').classList.add('hidden');

                            // 渲染批量结果
                            renderBatchResults();

                            // 平滑滚动到批量结果区域
                            document.getElementById('batch-results-container').scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                };
                img.src = url;
            });
        }

        // 更新进度条
        function updateProgressBar(processedCount, totalCount) {
            const progressBar = document.getElementById('progress-bar');
            const percentage = (processedCount / totalCount) * 100;
            progressBar.style.width = `${percentage}%`;
        }

        // 渲染批量结果
        function renderBatchResults() {
            const batchResultsContainer = document.getElementById('batch-results');
            batchResultsContainer.innerHTML = '';

            batchResults.forEach((result) => {
                const resultDiv = document.createElement('div');
                resultDiv.classList.add('relative', 'rounded-lg', 'overflow-hidden', 'border', 'border-neutral-200');

                const img = new Image();
                img.src = result.dataUrl;
                img.classList.add('w-full', 'h-auto', 'object-cover');
                resultDiv.appendChild(img);

                // 添加选择框
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = result.selected;
                checkbox.classList.add('absolute', 'top-2', 'left-2', 'z-10');
                checkbox.addEventListener('change', () => {
                    result.selected = checkbox.checked;
                });
                resultDiv.appendChild(checkbox);

                // 添加下载按钮
                const downloadButton = document.createElement('button');
                downloadButton.classList.add('absolute', 'bottom-2', 'right-2', 'bg-primary', 'hover:bg-primary/90', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs', 'flex', 'items-center', 'justify-center', 'z-10');
                downloadButton.innerHTML = '<i class="fa-solid fa-download mr-1"></i> 下载';
                downloadButton.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.download = result.isGif ? `合成图片_${result.index}.gif` : `合成图片_${result.index}.png`;
                    link.href = result.dataUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                resultDiv.appendChild(downloadButton);
                // 为图片添加点击事件监听器
                img.addEventListener('click', () => {
                    result.selected = !result.selected;
                    checkbox.checked = result.selected;
                });

                batchResultsContainer.appendChild(resultDiv);
            });
        }


        // 全选结果
        function selectAllResults() {
            batchResults.forEach(result => {
                result.selected = true;
            });
            renderBatchResults();
        }

        // 取消全选结果
        function deselectAllResults() {
            batchResults.forEach(result => {
                result.selected = false;
            });
            renderBatchResults();
        }

        // 下载选中结果
        function downloadSelectedResults() {
            const selectedResults = batchResults.filter(result => result.selected);
            selectedResults.forEach(result => {
                const link = document.createElement('a');
                link.download = `合成图片_${result.index}.${result.isGif ? 'gif' : 'png'}`;
                link.href = result.dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // 下载图片
        function downloadImage() {
            const link = document.createElement('a');
            link.download = '合成图片.png';
            link.href = resultCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 重置所有
        function resetAll() {
            imageA = null;
            document.getElementById('image-a').value = '';
            document.getElementById('preview-a-container').classList.add('hidden');
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('batch-results-container').classList.add('hidden');
            drawCanvas();
        }

        // 显示选择职业模态框
        function showCareerSelectionModal() {
            careerSelectionModal.classList.remove('hidden');
            careerImages.innerHTML = '';

            imageBUrls.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = '职业图片';
                img.classList.add('w-full', 'h-auto', 'object-cover', 'cursor-pointer');
                img.addEventListener('click', () => {
                    imageB.src = url;
                    careerSelectionModal.classList.add('hidden');
                    drawCanvas();
                });
                careerImages.appendChild(img);
            });
        }
    </script>
</body>

</html>